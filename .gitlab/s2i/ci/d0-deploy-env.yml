stages:
  - deploy-env
deploy-to-dev:
  stage: deploy-env
  script:
     - export K8S_NS_SUFFIX="-dev"
     - export K8S_KUBECONFIG=${K8S_KUBECONFIG_DEV}
     - export K8S_NS="" # nil will auto naming namespace
     - s2i . deploy
     - deploy-dev-post
  only:
    - /^rc.*$/
    - /^bugfix.*$/
    - /^feature.*$/
    - /^dev.*$/
  except:
    - master
    - /^hotfix.*$/
mirror-to-test:
  stage: deploy-env
  when: manual
  script:
    - export SRC_K8S_NS_SUFFIX="-dev"
    - export DST_K8S_NS_SUFFIX="-test"
    - export SRC_KUBE=${K8S_KUBECONFIG_DEV}
    - export DST_KUBE=${K8S_KUBECONFIG_TEST}
    - k8s-app-mirror ${SRC_KUBE} ${DST_KUBE} ${CI_PROJECT_NAME}
    - deploy-test-post
  only:
    - master
    - /^rc.*$/
    - /^bugfix.*$/
    - /^feature.*$/
    - /^dev.*$/
  except:
    - master
    - /^hotfix.*$/

deploy-to-uat:
  stage: deploy-env
  when: manual
  script:
     - export K8S_NS_SUFFIX="-uat"
     - export K8S_KUBECONFIG=${K8S_KUBECONFIG_UAT}
     - export K8S_NS="" # nil will auto naming namespace
     - s2i . deploy
     - deploy-uat-post
  only:
    - master
    - /^hotfix.*$/
mirror-to-prd:
  stage: deploy-env
  when: manual
  script:
     - export SRC_K8S_NS_SUFFIX="-uat"
     - export DST_K8S_NS_SUFFIX="-prd"
     - export SRC_KUBE=${K8S_KUBECONFIG_UAT}
     - export DST_KUBE=${K8S_KUBECONFIG_PRD}
     - k8s-app-mirror ${SRC_KUBE} ${DST_KUBEG} ${CI_PROJECT_NAME}
     - deploy-prd-post
  only:
    - master